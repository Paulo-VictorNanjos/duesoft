<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Configura√ß√µes da Moeda Virtual</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Configura√ß√µes B√°sicas</h6>
                            <div class="mb-3">
                                <label class="form-label">Nome da Moeda</label>
                                <input type="text" class="form-control" name="name" value="<%= currency?.name || 'BRL' %>" required>
                                <small class="text-muted">Ex: Coins, Pontos, Cr√©ditos</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">S√≠mbolo</label>
                                <input type="text" class="form-control" name="symbol" value="<%= currency?.symbol || 'B' %>" required>
                                <small class="text-muted">Ex: üí∞, üåü, ‚≠ê</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Taxa de Convers√£o (R$ 1,00 = X moedas)</label>
                                <input type="number" class="form-control" name="conversionRate" value="<%= currency?.conversionRate || '5' %>" required>
                                <small class="text-muted">Quantas moedas valem R$ 1,00</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <h6>Status Atual</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card bg-dark text-white">
                                        <div class="card-body">
                                            <h5>TOTAL EM CIRCULA√á√ÉO</h5>
                                            <h2><%= currency?.stats?.totalSupply || '0' %> <%= currency?.symbol || 'B' %></h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-dark text-white">
                                        <div class="card-body">
                                            <h5>TOTAL DE USU√ÅRIOS</h5>
                                            <h2><%= currency?.stats?.totalUsers || '0' %></h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-dark text-white">
                                        <div class="card-body">
                                            <h5>TOTAL DE TRANSA√á√ïES</h5>
                                            <h2><%= currency?.stats?.totalTransactions || '0' %></h2>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <h6>Regras de Recompensa</h6>
                            <div class="alert alert-info">
                                Configure quantas moedas os usu√°rios ganhar√£o por cada a√ß√£o realizada na plataforma.
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="mb-3">Cursos</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Completar Curso</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="earnRules.courseCompletion" 
                                                value="<%= currency?.settings?.earnRules?.courseCompletion || '70' %>" min="0">
                                            <span class="input-group-text"><%= currency?.symbol || 'B' %></span>
                                        </div>
                                        <small class="text-muted">Moedas ganhas ao completar um curso</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Primeiro Curso Completado</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="earnRules.firstCourseCompletion" 
                                                value="<%= currency?.settings?.earnRules?.firstCourseCompletion || '60' %>" min="0">
                                            <span class="input-group-text"><%= currency?.symbol || 'B' %></span>
                                        </div>
                                        <small class="text-muted">B√¥nus pelo primeiro curso completado</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Sequ√™ncia de Cursos</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="earnRules.courseStreak" 
                                                value="<%= currency?.settings?.earnRules?.courseStreak || '10' %>" min="0">
                                            <span class="input-group-text"><%= currency?.symbol || 'B' %></span>
                                        </div>
                                        <small class="text-muted">B√¥nus por sequ√™ncia de cursos completados</small>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="mb-3">Provas</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Completar Prova</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="earnRules.examCompletion" 
                                                value="<%= currency?.settings?.earnRules?.examCompletion || '30' %>" min="0">
                                            <span class="input-group-text"><%= currency?.symbol || 'B' %></span>
                                        </div>
                                        <small class="text-muted">Moedas ganhas ao completar uma prova</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Nota M√°xima</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="earnRules.perfectExamScore" 
                                                value="<%= currency?.settings?.earnRules?.perfectExamScore || '20' %>" min="0">
                                            <span class="input-group-text"><%= currency?.symbol || 'B' %></span>
                                        </div>
                                        <small class="text-muted">B√¥nus por atingir nota m√°xima em uma prova</small>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <h6 class="mb-3">Mentoria</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Sess√£o de Mentoria</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="earnRules.mentorSession" 
                                                value="<%= currency?.settings?.earnRules?.mentorSession || '50' %>" min="0">
                                            <span class="input-group-text"><%= currency?.symbol || 'B' %></span>
                                        </div>
                                        <small class="text-muted">Moedas ganhas ao participar de uma mentoria</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Avalia√ß√£o de Mentoria</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="earnRules.mentorRating" 
                                                value="<%= currency?.settings?.earnRules?.mentorRating || '20' %>" min="0">
                                            <span class="input-group-text"><%= currency?.symbol || 'B' %></span>
                                        </div>
                                        <small class="text-muted">Recompensa base para avalia√ß√£o 5 estrelas</small>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="mb-3">Outros</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Login Di√°rio</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="earnRules.dailyLogin" 
                                                value="<%= currency?.settings?.earnRules?.dailyLogin || '10' %>" min="0">
                                            <span class="input-group-text"><%= currency?.symbol || 'B' %></span>
                                        </div>
                                        <small class="text-muted">Moedas ganhas pelo primeiro login do dia</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">B√¥nus de Indica√ß√£o</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" name="earnRules.referralBonus" 
                                                value="<%= currency?.settings?.earnRules?.referralBonus || '30' %>" min="0">
                                            <span class="input-group-text"><%= currency?.symbol || 'B' %></span>
                                        </div>
                                        <small class="text-muted">Moedas ganhas ao indicar um novo usu√°rio</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i> Salvar Configura√ß√µes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('currencySettingsForm');
    const withdrawEnabledCheckbox = form.querySelector('input[name="withdrawEnabled"]');
    
    console.log('Estado inicial do checkbox:', {
        checked: withdrawEnabledCheckbox.checked,
        value: withdrawEnabledCheckbox.value
    });
    
    withdrawEnabledCheckbox.addEventListener('change', function(e) {
        console.log('Checkbox alterado:', {
            checked: e.target.checked,
            value: e.target.value
        });
    });
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        console.log('FormData antes da convers√£o:', {
            has: formData.has('withdrawEnabled'),
            get: formData.get('withdrawEnabled')
        });
        
        const data = Object.fromEntries(formData.entries());
        console.log('Dados antes de processar withdrawEnabled:', data);
        
        // Garantir que withdrawEnabled seja sempre um booleano
        data.withdrawEnabled = withdrawEnabledCheckbox.checked;
        
        console.log('Dados finais a serem enviados:', data);
        
        try {
            const response = await fetch('/admin/virtual-currency/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            console.log('Resposta do servidor:', result);
            
            if (response.ok) {
                console.log('Configura√ß√µes salvas com sucesso. Estado final do checkbox:', withdrawEnabledCheckbox.checked);
                toastr.success('Configura√ß√µes salvas com sucesso!');
                // Atualizar a p√°gina para mostrar os novos valores
                setTimeout(() => window.location.reload(), 1000);
            } else {
                console.error('Erro na resposta:', result);
                toastr.error(result.message || 'Erro ao salvar configura√ß√µes');
            }
        } catch (error) {
            console.error('Erro ao processar requisi√ß√£o:', error);
            toastr.error('Erro ao processar requisi√ß√£o');
        }
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const earnRulesForm = document.getElementById('earnRulesForm');
    
    earnRulesForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const earnRules = {};
        
        console.log('==== DEBUG FRONTEND ====');
        console.log('1. FormData entries:', Array.from(formData.entries()));
        
        // Converter os dados do formul√°rio para objeto
        for (let [key, value] of formData.entries()) {
            if (key.startsWith('earnRules.')) {
                const fieldName = key.replace('earnRules.', '');
                earnRules[fieldName] = Number(value);
            }
        }
        
        console.log('2. Objeto earnRules montado:', earnRules);
        
        try {
            const response = await fetch('/admin/virtual-currency/earn-rules', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ earnRules })
            });
            
            console.log('3. Resposta do servidor:', await response.clone().json());
            
            const result = await response.json();
            
            if (response.ok) {
                toastr.success('Regras de recompensa salvas com sucesso!');
                // Atualizar os campos com os valores retornados
                for (let [key, value] of Object.entries(result.earnRules)) {
                    const input = document.querySelector(`input[name="earnRules.${key}"]`);
                    if (input) input.value = value;
                }
            } else {
                console.error('Erro na resposta:', result);
                toastr.error(result.message || 'Erro ao salvar regras de recompensa');
            }
        } catch (error) {
            console.error('Erro:', error);
            toastr.error('Erro ao processar requisi√ß√£o');
        }
    });
});
</script> 